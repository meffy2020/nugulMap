# NugulMap 백엔드 개요

백엔드는 `API 서버`와 `데이터 스크립트`라는 두 가지 주요 서비스로 구성됩니다.

---

## 1. API 서버 (Spring Boot)

비즈니스 로직, 사용자 상호작용, 핵심 API 엔드포인트를 처리하는 메인 애플리케이션 서버입니다.

### 1.1. 아키텍처 및 기술 스택

-   **프레임워크:** Spring Boot
-   **언어:** Java
-   **빌드 도구:** Gradle
-   **데이터베이스:**
    -   JPA (Hibernate)를 사용한 객체-관계 매핑(ORM).
    -   개발 환경(`dev` 프로필)에서는 H2 인메모리 데이터베이스 사용.
    -   `schema.sql`로 스키마를 초기화하고 `data.sql`로 테스트 데이터를 채웁니다.
    -   데이터베이스 제약 조건 강화를 위해 Flyway 마이그레이션(`V2__...`)을 포함합니다.
-   **인증:**
    -   상태 비저장 API 인증을 위한 JWT (JSON Web Tokens) 사용.
    -   소셜 로그인(Google, Kakao, Naver)을 위해 Spring Security와 OAuth2 지원.
-   **스토리지:**
    -   파일 업로드를 처리하기 위한 `StorageService` 추상화 계층.
    -   애플리케이션 프로필을 통해 로컬 파일 시스템(`StorageServiceImpl`)과 AWS S3(`S3StorageServiceImpl`) 저장소 간 전환을 지원합니다.
-   **배포:**
    -   컨테이너화를 위한 `Dockerfile` 제공. 최적화된 소형 최종 이미지를 생성하기 위해 멀티-스테이지 빌드를 사용합니다.

### 1.2. 주요 기능 및 서비스

-   **UserService:** OAuth 데이터를 이용한 사용자 생성, 정보 업데이트, 조회를 포함한 사용자 생명주기를 관리합니다.
-   **ZoneService:** "존(흡연구역)"을 관리합니다.
    -   Zone에 대한 CRUD 작업.
    -   지정된 반경 내 위치 기반 검색.
    -   키워드 기반 검색.
-   **ImageService:** 이미지 처리 및 저장을 담당합니다.
    -   이미지 크기 및 유형 유효성 검사.
    -   고유한 파일 이름 생성.
    -   설정된 스토리지(로컬 또는 S3)에 이미지를 저장.
    -   이미지를 `profiles`와 `zones` 디렉토리로 분리하여 관리.
-   **Security:**
    -   `DevSecurityConfig`: `dev` 프로필용 설정으로, 개발 및 테스트 편의를 위해 모든 요청을 허용합니다.
    -   `SecurityConfig`: `prod` 프로필용 설정으로, 엔드포인트를 보호하고 JWT 유효성 검사를 활성화하며 OAuth2 로그인 흐름을 구성합니다.
-   **GlobalExceptionHandler:** 중앙 집중식 예외 처리를 통해 다양한 유형의 오류(예: 유효성 검사, 데이터베이스, 파일 저장소)에 대해 일관된 JSON 형식의 오류 응답을 제공합니다.

### 1.3. 주요 API 엔드포인트

-   `/users`: 사용자 관리 (CRUD).
-   `/zones`: 흡연구역 관리 (CRUD, 검색, 주변 검색).
-   `/images`: 이미지 업로드 및 조회.
-   `/oauth2`: 소셜 프로바이더를 통한 OAuth2 로그인 흐름 처리.
-   `/test`: 모든 서비스를 수동으로 테스트하기 위한 포괄적인 엔드포인트 및 HTML 뷰 제공.

---

## 2. 데이터 스크립트 (Python)

주로 Google Firebase와 상호작용하며 데이터 관리를 위한 보조 서비스 및 스크립트 모음입니다.

### 2.1. 아키텍처 및 기술 스택

-   **프레임워크:** FastAPI (서비스로 실행 가능).
-   **언어:** Python 3.9
-   **데이터베이스:** Google Cloud Firestore.
-   **핵심 기능:**
    -   Firestore에 저장된 `markers`에 대한 CRUD 작업을 위한 REST API 제공.
    -   데이터 마이그레이션 및 처리를 위한 스크립트 포함.
-   **배포:** `uvicorn`을 사용하여 컨테이너화를 위한 `Dockerfile` 제공.

### 2.2. 주요 스크립트 및 기능

-   **`api/routes.py`**: 마커에 대한 `POST`, `GET`, `PUT`, `DELETE` 작업을 위한 FastAPI 라우터를 정의합니다.
-   **`core/firebase.py`**: 서비스 자격 증명을 사용하여 Google Firestore와의 연결 및 인증을 처리합니다.
-   **`scripts/upload_csv_to_firestore.py`**:
    -   디렉토리에서 CSV 파일을 읽는 강력한 유틸리티 스크립트.
    -   다양한 CSV 소스의 각기 다른 컬럼 이름을 공통 스키마(예: "자치구명" -> "region")로 자동 매핑합니다.
    -   데이터를 정제하고 표준화합니다.
    -   주소 정보가 누락된 경우 **카카오맵 API**를 사용하여 주소를 위도/경도 좌표로 지오코딩합니다.
    -   처리된 데이터를 Firestore의 `markers` 컬렉션에 업로드하며, 덮어쓰기를 방지하기 위해 중복을 확인합니다.

이 서비스는 외부 데이터셋을 애플리케이션의 데이터베이스로 준비하고 마이그레이션하는 데이터 파이프라인 역할을 합니다.
